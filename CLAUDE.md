# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n\n## Project Overview\n\nSoftware Inventory Management System for tracking mainframe software in a multi-tenant environment. Built with SvelteKit, TypeScript, Prisma, and PostgreSQL.\n\n## Development Commands\n\n### Setup & Database\n```bash\nnpm install                                        # Install dependencies\nnpx prisma generate                               # Generate Prisma client\nnpx prisma db push                                # Push schema to database\n\n# Data Management - Choose one approach:\n\n# Option A: TypeScript seed script\nnpx prisma db seed                                # Seed via TypeScript (seed.ts)\n\n# Option B: SQL scripts (recommended for production-like workflows)\nnpx tsx prisma/scripts/run-sql.ts reset           # Empty all tables\nnpx tsx prisma/scripts/run-sql.ts test-data       # Load test data\nnpx tsx prisma/scripts/run-sql.ts reset-and-load  # Reset + load (full refresh)\n\n# Database Tools\nnpx prisma studio                                 # Open Prisma Studio on http://localhost:5556\n```\n\n### Development\n```bash\nnpm run dev                   # Start dev server on http://localhost:5173\nnpm run build                 # Build for production\nnpm run preview               # Preview production build\nnpm run check                 # Type-check without watching\nnpm run check:watch           # Type-check with watch mode\n```\n\n### Database Connection\nSet `DATABASE_URL` environment variable to PostgreSQL connection string. The application uses Prisma with PostgreSQL.\n\n## Architecture\n\n### Data Model Hierarchy\n\nThe system follows this entity relationship:\n- **Vendors** → create **Software** products\n- **Software** → has multiple **Software Versions** (normalized table)\n- **Software Versions** → referenced by **Package Items**\n- **Packages** → contain **Package Items** → assigned to **LPARs**\n- **Customers** → own **LPARs**\n- **LPARs** → track installed **Software** with version history via **lpar_software**\n\n**Key Tables**:\n- `software_versions`: Normalized version history (replaces JSON `version_history`)\n- `package_items`: Links packages to specific software versions\n- `lpar_software`: Current and previous versions installed on each LPAR\n\n### Version Management\n\n**Critical**: Software versions are now **normalized** in the `software_versions` table:\n- Version format: `V5R6M0` or `2.4.0`\n- PTF levels: `PTF12345` or `SO12345` (vendor-specific)\n- Each version is a separate row with release dates, support info, and release notes\n- `software.current_version_id` points to the active version\n- `is_current` flag marks the current version for each software product\n\nThe `version-parser.ts` utility provides:\n- `parseVendorDesignation()`: Extract version and PTF from vendor strings\n- `compareVersions()`, `comparePtfLevels()`: Version comparison logic\n- `isVersionCompatible()`: Check if installed version meets requirements\n\n**When working with versions**:\n- Create new rows in `software_versions` table, not JSON arrays\n- Query version history via `software.versions` relation\n- Reference specific versions in packages via `software_version_id`\n- Update `software.current_version_id` when releasing new versions\n- PTF levels are vendor-specific (IBM uses PTF, Broadcom uses SO)\n\n### Database Layer\n\n**Location**: `src/lib/server/db.ts`\n\nPrisma singleton pattern with helper functions:\n- `db`: PrismaClient instance (reused in dev to prevent connection exhaustion)\n- `getPaginated()`: Generic pagination for any model\n- `softDelete()`: Sets `active: false` instead of deleting\n- `createAuditLog()`: Logs entity changes\n\n**In +page.server.ts files**:\n```typescript\nimport { db } from '$lib/server/db';\n// Use db.vendors, db.software, db.packages, db.lpars, etc.\n```\n\n### Server Load Functions\n\nAll routes use SvelteKit's `+page.server.ts` pattern:\n- `load()`: Fetch data from Prisma\n- Include relations needed for display (e.g., `include: { vendors: true }`)\n- Handle pagination, filtering, sorting\n- Use `error()` for 404s\n\n### Form Validation\n\nUses Superforms with Zod schemas from `src/lib/schemas/index.ts`:\n- Schemas mirror Prisma models with validation rules\n- Codes must be `UPPERCASE_WITH_UNDERSCORES_OR_DASHES`\n- Nested objects use `softwareVersionSchema` for version/PTF pairs\n- Forms use `superValidate()` in `load()` and form actions\n\n### Component Organization\n\n**Base UI** (`src/lib/components/ui/`):\n- Primitive components (Button, Card, Input, Badge)\n- Based on shadcn design patterns\n- Styled with Tailwind CSS\n\n**Common** (`src/lib/components/common/`):\n- `DataTable.svelte`: Generic table with sorting, pagination (uses Svelte 5 generics)\n- `Pagination.svelte`: Pagination controls\n- `FormField.svelte`: Form field with validation errors\n\n**Domain** (`src/lib/components/domain/`):\n- `VersionDisplay.svelte`: Display version with PTF level formatting\n\n### Path Aliases\n\nConfigured in `svelte.config.js`:\n```typescript\n$lib          → src/lib\n$components   → src/lib/components\n$types        → src/lib/types\n$utils        → src/lib/utils\n$stores       → src/lib/stores\n$schemas      → src/lib/schemas\n```\n\n## Mainframe Concepts\n\n### Packages\nCoordinated software releases containing multiple products tested together:\n- Include ALL software the service provider manages\n- Each item has specific version and PTF level\n- Items marked as `required` or optional\n- `order_index` determines installation order\n\n### LPARs (Logical Partitions)\nCustomer environments that run software:\n- Each LPAR belongs to one customer\n- Assigned to a specific package version\n- Tracks currently installed software with version history\n- Can have different versions than assigned package (due to rollbacks)\n\n### Rollback Support\nIndividual software can be rolled back if issues occur:\n- Previous version stored in `lpar_software` table\n- `rolled_back` flag tracks rollback state\n- `rolled_back_at` timestamp tracks when rollback occurred\n- `rollback_reason` field explains why rollback was needed\n- Does NOT affect other software in the package\n- Audit log records rollback events\n\n### Audit Logging\nAll entity changes logged to `audit_log` table:\n- Tracks creates, updates, deletes, rollbacks, version updates\n- JSON `changes` field stores before/after state\n- Indexed by entity type, entity ID, and timestamp\n- Optional `user_id` for user tracking (not yet implemented)\n\n## Database Views and Functions\n\nThe database includes several powerful views and functions for common queries:\n\n### Views (Auto-Updated)\n- **`software_with_current_version`**: Software with current version details denormalized\n- **`lpar_package_compliance`**: Compliance status of LPARs vs assigned packages\n- **`rollback_history`**: Complete rollback history with timing analysis\n- **`software_adoption_rate`**: Version adoption statistics across LPARs\n- **`lpar_dashboard`** (materialized): Pre-computed dashboard metrics (refresh with `REFRESH MATERIALIZED VIEW lpar_dashboard`)\n\n### Functions\n- **`get_version_upgrade_path(software_id, from_version, to_version)`**: Returns ordered upgrade path\n- **`check_package_deployment_impact(lpar_id, package_id)`**: Simulates deployment changes\n- **`get_software_problem_score(software_id, days_lookback)`**: Calculates problem score from rollbacks\n- **`refresh_dashboard()`**: Helper to refresh the materialized view\n\n**Usage Example**:\n```typescript\n// In +page.server.ts\nconst compliance = await db.$queryRaw`\n  SELECT * FROM lpar_package_compliance\n  WHERE customer_id = ${customerId}\n  AND compliance_status != 'COMPLIANT'\n`;\n\nconst upgradePath = await db.$queryRaw`\n  SELECT * FROM get_version_upgrade_path(\n    ${softwareId}::uuid,\n    'V5R4M0',\n    'V5R6M0'\n  )\n`;\n```\n\nSee `prisma/migrations/add_views_and_functions.sql` for full documentation.\n\n## Key Files\n\n**Database:**\n- `prisma/schema.prisma`: Database schema with all models\n- `prisma/seed.ts`: TypeScript seed script (alternative to SQL scripts)\n- `prisma/scripts/reset.sql`: Empty all tables (preserves schema/views)\n- `prisma/scripts/test-data.sql`: Load test data via SQL\n- `prisma/scripts/run-sql.ts`: Helper to execute SQL scripts\n- `prisma/migrations/add_views_and_functions.sql`: Database views and functions\n\n**Application:**\n- `src/lib/server/db.ts`: Database singleton and helper functions\n- `src/lib/utils/version-parser.ts`: Version parsing and comparison logic\n- `src/lib/schemas/index.ts`: Zod validation schemas\n- `src/routes/+layout.svelte`: Navigation and page structure\n\n## Development Notes\n\n### When Adding New Features\n1. Update Prisma schema if database changes needed\n2. Run `npx prisma db push` to update database\n3. Add/update Zod schemas for validation\n4. Create/update TypeScript types in `src/lib/types/`\n5. Implement server load functions in `+page.server.ts`\n6. Build UI with existing components where possible\n\n### Testing Data\n\n**Option A: TypeScript Seed** (integrates with Prisma)\n```bash\nnpx prisma db seed\n```\n\n**Option B: SQL Scripts** (production-like, more explicit)\n```bash\nnpx tsx prisma/scripts/run-sql.ts reset-and-load\n```\n\nBoth methods create the same test data:\n- 2 vendors (IBM, Broadcom)\n- 2 customers (Acme, Globex)\n- 3 software products (CICS, DB2, Endevor)\n- 8 software versions (3 versions per product showing upgrade history)\n- 2 packages (Q1 2025, Q4 2024)\n- 3 LPARs with installed software\n- 2 audit log entries\n\n**SQL Scripts Benefits:**\n- Explicit control over data loading\n- Can run reset without reloading data (useful for prod setup)\n- Easier to customize for different environments\n- Clearer for DBAs and ops teams\n\n### Common Patterns\n- **Soft Deletes**: All main tables have `active`, `deleted_at`, and `deleted_by` fields\n- **Timestamps**: All models have `created_at` and `updated_at` (auto-managed by Prisma)\n- **UUIDs**: All IDs use native PostgreSQL UUID with `gen_random_uuid()`\n- **Codes**: Unique business identifiers for external reference (e.g., "PROD-LPAR-1")\n- **Version History**: Normalized in `software_versions` table (not JSON)\n- **Foreign Key Constraints**: All relations have explicit `onDelete` behaviors:\n  - `Cascade`: Junction tables (package_items, lpar_software)\n  - `Restrict`: Reference data (vendors, customers, software)\n  - `SetNull`: Optional references (current_package_id, current_version_id)\n- **Unique Constraints**: Prevent duplicates:\n  - `[vendor_id, name]` on software (no duplicate products per vendor)\n  - `[software_id, version, ptf_level]` on software_versions\n  - `[package_id, order_index]` on package_items (installation order)\n  - `[lpar_id, software_id]` on lpar_software (one install per LPAR)\n